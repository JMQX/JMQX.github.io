<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Netty快速入门 | 江民钦的博客</title>

  
  <meta name="author" content="JiangMinQin">
  

  
  <meta name="description" content="Netty是由JBOSS提供的一个java开源的、基于NIO的、异步的、事件驱动的网络应用程序框架和工具，用来快速开发高性能、高并发、高可靠的网络服务器和客户端程序，大多数用于服务端开发，为Java游戏服务器开发必学框架之一。

简单来说，Netty是一个基于NIO(No-block IO)的提供了对TCP、UDP、HTTP以及文件传输的支持，通过Reactor反应器模式，可以快速开发高性能的应用程序。">
  

  
  
  <meta name="keywords" content="Netty">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="Netty快速入门"/>

  <meta property="og:site_name" content="江民钦的博客"/>

  
  <meta property="og:image" content="/images/avatar.jpg"/>
  

  <link href="/images/avatar.jpg" rel="icon">
  <link rel="alternate" href="/atom.xml" title="江民钦的博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">江民钦的博客</a>
    </h1>
    <p class="site-description">show me code</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="https://github.com/JMQX">GitHub</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>Netty快速入门</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/08/01/Netty快速入门/" rel="bookmark">
        <time class="entry-date published" datetime="2017-08-01T14:03:38.000Z">
          2017-08-01
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <pre><code>Netty是由JBOSS提供的一个java开源的、基于NIO的、异步的、事件驱动的网络应用程序框架和工具，用来快速开发高性能、高并发、高可靠的网络服务器和客户端程序，大多数用于服务端开发，为Java游戏服务器开发必学框架之一。

简单来说，Netty是一个基于NIO(No-block IO)的提供了对TCP、UDP、HTTP以及文件传输的支持，通过Reactor反应器模式，可以快速开发高性能的应用程序。
</code></pre><a id="more"></a>
<pre><code>上一个简单的dome：
</code></pre><h4 id="Server端"><a href="#Server端" class="headerlink" title="Server端"></a>Server端</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line">import io.netty.bootstrap.ServerBootstrap;</div><div class="line">import io.netty.buffer.ByteBuf;</div><div class="line">import io.netty.buffer.Unpooled;</div><div class="line">import io.netty.channel.ChannelFuture;</div><div class="line">import io.netty.channel.ChannelHandlerAdapter;</div><div class="line">import io.netty.channel.ChannelHandlerContext;</div><div class="line">import io.netty.channel.ChannelInitializer;</div><div class="line">import io.netty.channel.ChannelOption;</div><div class="line">import io.netty.channel.EventLoopGroup;</div><div class="line">import io.netty.channel.nio.NioEventLoopGroup;</div><div class="line">import io.netty.channel.socket.SocketChannel;</div><div class="line">import io.netty.channel.socket.nio.NioServerSocketChannel;</div><div class="line"></div><div class="line">public class NettyServer &#123;</div><div class="line"></div><div class="line">    public void bind(int port)&#123;</div><div class="line">        EventLoopGroup bossGroup=new NioEventLoopGroup();</div><div class="line">        EventLoopGroup workerGroup=new NioEventLoopGroup();</div><div class="line">        ServerBootstrap b=new ServerBootstrap();</div><div class="line">        b.group(bossGroup,workerGroup)</div><div class="line">            .channel(NioServerSocketChannel.class)</div><div class="line">            .option(ChannelOption.SO_BACKLOG,1024)</div><div class="line">            .childHandler(new ChildChannelHandler());</div><div class="line">        try &#123;</div><div class="line">            ChannelFuture f=b.bind(port).sync();</div><div class="line">            f.channel().closeFuture().sync();</div><div class="line">        &#125; catch (InterruptedException e) &#123;</div><div class="line">            // TODO Auto-generated catch block</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;finally&#123;</div><div class="line">            bossGroup.shutdownGracefully();</div><div class="line">            workerGroup.shutdownGracefully();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    public static void main(String[] args) &#123;    </div><div class="line">        int port=8989;</div><div class="line">        new NettyServer().bind(port);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line">class ChildChannelHandler extends ChannelInitializer&lt;SocketChannel&gt;&#123;</div><div class="line"></div><div class="line">    public static int count=1;</div><div class="line">    @Override</div><div class="line">    protected void initChannel(SocketChannel arg0) throws Exception &#123;</div><div class="line">        // TODO Auto-generated method stub</div><div class="line">        arg0.pipeline().addLast(new NettyServerHandler());</div><div class="line">        System.out.println(&quot;connect server number:  &quot;+ChildChannelHandler.count++);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class NettyServerHandler extends ChannelHandlerAdapter&#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;</div><div class="line">        // TODO Auto-generated method stub</div><div class="line">        ByteBuf buf=(ByteBuf)msg;</div><div class="line">        byte[] req=new byte[buf.readableBytes()];</div><div class="line">        buf.readBytes(req);</div><div class="line">        String body=new String(req,&quot;utf-8&quot;);</div><div class="line">        System.out.println(&quot;receive:  &quot;+body);</div><div class="line">        String toClient=&quot;hello client&quot;;</div><div class="line">        ByteBuf resp=Unpooled.buffer(toClient.getBytes().length);</div><div class="line">        resp.writeBytes(toClient.getBytes());</div><div class="line">        ctx.write(resp);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void channelReadComplete(ChannelHandlerContext ctx) throws Exception &#123;</div><div class="line">        // TODO Auto-generated method stub</div><div class="line">        ctx.flush();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception &#123;</div><div class="line">        // TODO Auto-generated method stub</div><div class="line">        ctx.close();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Client端"><a href="#Client端" class="headerlink" title="Client端:"></a>Client端:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line">import java.util.logging.Logger;</div><div class="line">import io.netty.bootstrap.Bootstrap;</div><div class="line">import io.netty.buffer.ByteBuf;</div><div class="line">import io.netty.buffer.Unpooled;</div><div class="line">import io.netty.channel.ChannelFuture;</div><div class="line">import io.netty.channel.ChannelHandlerAdapter;</div><div class="line">import io.netty.channel.ChannelHandlerContext;</div><div class="line">import io.netty.channel.ChannelInitializer;</div><div class="line">import io.netty.channel.ChannelOption;</div><div class="line">import io.netty.channel.EventLoopGroup;</div><div class="line">import io.netty.channel.nio.NioEventLoopGroup;</div><div class="line">import io.netty.channel.socket.SocketChannel;</div><div class="line">import io.netty.channel.socket.nio.NioSocketChannel;</div><div class="line"></div><div class="line">public class NettyClient &#123;</div><div class="line">    public void connect(String host,int port)&#123;</div><div class="line">        EventLoopGroup group=new NioEventLoopGroup();</div><div class="line">        Bootstrap b=new Bootstrap();</div><div class="line">        b.group(group)</div><div class="line">        .channel(NioSocketChannel.class)</div><div class="line">        .option(ChannelOption.TCP_NODELAY, true)</div><div class="line">        .handler(new ChannelInitializer&lt;SocketChannel&gt;()&#123;</div><div class="line"></div><div class="line">            @Override</div><div class="line">            protected void initChannel(SocketChannel arg0) throws Exception &#123;</div><div class="line">                // TODO Auto-generated method stub</div><div class="line">                arg0.pipeline().addLast(new NettyClientHandler());</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">        &#125;);</div><div class="line">        </div><div class="line">        try &#123;</div><div class="line">            ChannelFuture f=b.connect(host,port).sync();</div><div class="line">            f.channel().closeFuture().sync();</div><div class="line">        &#125; catch (InterruptedException e) &#123;</div><div class="line">            // TODO Auto-generated catch block</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;finally&#123;</div><div class="line">            group.shutdownGracefully();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        // TODO Auto-generated method stub</div><div class="line">        String host=&quot;127.0.0.1&quot;;</div><div class="line">        int port=8989;</div><div class="line">        new NettyClient().connect(host, port);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line">class NettyClientHandler extends ChannelHandlerAdapter&#123;</div><div class="line">    private final static Logger logger=Logger.getLogger(NettyClientHandler.class.getName());</div><div class="line">    </div><div class="line">    private ByteBuf firstMessage=null;</div><div class="line">    </div><div class="line">    public NettyClientHandler()&#123;</div><div class="line">        byte[] req=&quot;hello server&quot;.getBytes();</div><div class="line">        firstMessage=Unpooled.buffer(req.length);</div><div class="line">        firstMessage.writeBytes(req);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void channelActive(ChannelHandlerContext ctx) throws Exception &#123;</div><div class="line">        // TODO Auto-generated method stub</div><div class="line">        ctx.writeAndFlush(firstMessage);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;</div><div class="line">        // TODO Auto-generated method stub</div><div class="line">        ByteBuf buf=(ByteBuf)msg;</div><div class="line">        byte[] req=new byte[buf.readableBytes()];</div><div class="line">        buf.readBytes(req);</div><div class="line">        String body=new String(req,&quot;utf-8&quot;);</div><div class="line">        System.out.println(&quot;Now is:   &quot;+body);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception &#123;</div><div class="line">        // TODO Auto-generated method stub</div><div class="line">        logger.warning(&quot;Logger Warning:   &quot;+cause.getMessage()); //打印异常信息</div><div class="line">        ctx.close();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Server端和Client端的代码都极其相似，主要是Server用了两个NioEventLoopGroup，一个用来接受client连接，一个用来进行对SocketChannel读写。ServerBootstrap用来启动NIO服务端的辅助启动类，目的是降低服务端的开发程度。简单说一下Channel和SocketChannel，常规的TCP通信是基于Socket的，然后同过字节流的方式进行传输，效率很低，在NIO中，通过Channel这种以块的模式进行传输数据，SocketChannel是Channel中的一种用以Socket传输的方式。</p>
<p>在netty中，不管是客户端还是服务端，一旦建立连接，首先初始化channel，通过new一个ChannelInitializer<socketchannel>这个类或者自己写一个外部类然后继承于这个类，并重写其中的initChannel方法，获得SocketChannel后可以通过管道的方式添加一个handler(可以是一个外部类通过继承ChannelHandlerAdapter，来实现具体的业务逻辑处理)，这里还可以添加其它中间件，比如new StringDecoder(),用来将传输的字节流数据自动转换换成字符串；以及new LineBasedFrameDecoder()或者new DeLimitFrameDecoder()等进行TCP粘包/拆包。</socketchannel></p>
<p>在上边自定义ChannelHandlerAdapter的子类中,Server端中channelRead()方法是在接收到数据时运行,channelReadComplete()方法是在数据读取完成是运行,exceptionCaught是在发生异常是运行。Client不同的是<br>channelActive()方法是在连接成功后运行。其中发送数据都是ctx.writeAndFlush(ByteBuf),注意是发送字节，不能直接发送字符串，不然会发送不出去。</p>
<h4 id="关于TCP粘包-拆包"><a href="#关于TCP粘包-拆包" class="headerlink" title="关于TCP粘包/拆包"></a>关于TCP粘包/拆包</h4><p>简而言之，在网络传输中，数据是基于字节流的，一次最大能发送多少个字节的数据，跟操作系统有关以及硬件配置有关，发送的数据与数据之间是没有间隔的，是连接在一起的，会出现一次发送一条数据外加另一条数据的一部分等情况，那么怎么让客户端知道读取到某的地方时该是下一条数据，通常用\n或者\t\n来分辨，LineBasedFrameDecoder这个中间件就是通过\n和\t\n来区分。 DeLimitFrameDecoder则是以一个自定义的字符进行区分。</p>
<h4 id="使用LineBasedFrameDecoder以及StringDecoder"><a href="#使用LineBasedFrameDecoder以及StringDecoder" class="headerlink" title="使用LineBasedFrameDecoder以及StringDecoder"></a>使用LineBasedFrameDecoder以及StringDecoder</h4><p>Server:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">public class NettyServer &#123;</div><div class="line"></div><div class="line">    public void bind(int port)&#123;</div><div class="line">        EventLoopGroup bossGroup=new NioEventLoopGroup();</div><div class="line">        EventLoopGroup workerGroup=new NioEventLoopGroup();</div><div class="line">        ServerBootstrap b=new ServerBootstrap();</div><div class="line">        b.group(bossGroup,workerGroup)</div><div class="line">            .channel(NioServerSocketChannel.class)</div><div class="line">            .option(ChannelOption.SO_BACKLOG,1024)</div><div class="line">            .childHandler(new ChildChannelHandler());</div><div class="line">        try &#123;</div><div class="line">            ChannelFuture f=b.bind(port).sync();</div><div class="line">            f.channel().closeFuture().sync();</div><div class="line">        &#125; catch (InterruptedException e) &#123;</div><div class="line">            // TODO Auto-generated catch block</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;finally&#123;</div><div class="line">            bossGroup.shutdownGracefully();</div><div class="line">            workerGroup.shutdownGracefully();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    public static void main(String[] args) &#123;    </div><div class="line">        int port=8989;</div><div class="line">        new NettyServer().bind(port);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line">class ChildChannelHandler extends ChannelInitializer&lt;SocketChannel&gt;&#123;</div><div class="line"></div><div class="line">    public static int count=1;</div><div class="line">    @Override</div><div class="line">    protected void initChannel(SocketChannel arg0) throws Exception &#123;</div><div class="line">        // TODO Auto-generated method stub</div><div class="line">        arg0.pipeline().addLast(new StringDecoder());</div><div class="line">        arg0.pipeline().addLast(new LineBasedFrameDecoder(1024));</div><div class="line">        arg0.pipeline().addLast(new NettyServerHandler());</div><div class="line">        System.out.println(&quot;connect server number:  &quot;+ChildChannelHandler.count++);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class NettyServerHandler extends ChannelHandlerAdapter&#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;</div><div class="line">        // TODO Auto-generated method stub</div><div class="line">        String buf=(String)msg;</div><div class="line">        System.out.println(&quot;receive:  &quot;+buf);</div><div class="line">        String toClient=&quot;hello client\n&quot;;</div><div class="line">        ByteBuf resp=Unpooled.buffer(toClient.getBytes().length);</div><div class="line">        resp.writeBytes(toClient.getBytes());</div><div class="line">        ctx.write(resp);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void channelReadComplete(ChannelHandlerContext ctx) throws Exception &#123;</div><div class="line">        // TODO Auto-generated method stub</div><div class="line">        ctx.flush();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception &#123;</div><div class="line">        // TODO Auto-generated method stub</div><div class="line">        ctx.close();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Client:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">public class NettyClient &#123;</div><div class="line">    public void connect(String host,int port)&#123;</div><div class="line">        EventLoopGroup group=new NioEventLoopGroup();</div><div class="line">        Bootstrap b=new Bootstrap();</div><div class="line">        b.group(group)</div><div class="line">        .channel(NioSocketChannel.class)</div><div class="line">        .option(ChannelOption.TCP_NODELAY, true)</div><div class="line">        .handler(new ChannelInitializer&lt;SocketChannel&gt;()&#123;</div><div class="line"></div><div class="line">            @Override</div><div class="line">            protected void initChannel(SocketChannel arg0) throws Exception &#123;</div><div class="line">                // TODO Auto-generated method stub</div><div class="line">                arg0.pipeline().addLast(new StringDecoder());</div><div class="line">                arg0.pipeline().addLast(new LineBasedFrameDecoder(1024));</div><div class="line">                arg0.pipeline().addLast(new NettyClientHandler());</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">        &#125;);</div><div class="line">        </div><div class="line">        try &#123;</div><div class="line">            ChannelFuture f=b.connect(host,port).sync();</div><div class="line">            f.channel().closeFuture().sync();</div><div class="line">        &#125; catch (InterruptedException e) &#123;</div><div class="line">            // TODO Auto-generated catch block</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;finally&#123;</div><div class="line">            group.shutdownGracefully();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        // TODO Auto-generated method stub</div><div class="line">        String host=&quot;127.0.0.1&quot;;</div><div class="line">        int port=8989;</div><div class="line">        new NettyClient().connect(host, port);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line">class NettyClientHandler extends ChannelHandlerAdapter&#123;</div><div class="line">    private final static Logger logger=Logger.getLogger(NettyClientHandler.class.getName());</div><div class="line">    </div><div class="line">    private ByteBuf firstMessage=null;</div><div class="line">    </div><div class="line">    public NettyClientHandler()&#123;</div><div class="line">        byte[] req=&quot;hello server\n&quot;.getBytes();</div><div class="line">        firstMessage=Unpooled.buffer(req.length);</div><div class="line">        firstMessage.writeBytes(req);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void channelActive(ChannelHandlerContext ctx) throws Exception &#123;</div><div class="line">        // TODO Auto-generated method stub</div><div class="line">        ctx.writeAndFlush(firstMessage);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception &#123;</div><div class="line">        // TODO Auto-generated method stub</div><div class="line">        String buf=(String)msg;</div><div class="line">        System.out.println(&quot;Now is:   &quot;+buf);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception &#123;</div><div class="line">        // TODO Auto-generated method stub</div><div class="line">        logger.warning(&quot;Logger Warning:   &quot;+cause.getMessage());</div><div class="line">        ctx.close();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意使用LineBasedFrameDecoder后记得在发送的数据后边加\n,使用StringDecoder后，在channelRead方法里边的msg自动被转换成了字符串，但是发送数据时，仍然要发送字节流数据。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Netty/">Netty</a>
    </span>
    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2017 JiangMinQin
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>